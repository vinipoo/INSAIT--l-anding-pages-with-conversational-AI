<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Discover Card Pre-Approval ¬∑ Nova AI</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --orange: #FF6200;
      --orange-light: #FFF4EE;
      --orange-mid: #FFD5B8;
      --navy: #1A1A2E;
      --navy-soft: #2D2D44;
      --gray: #6B7280;
      --gray-light: #F3F4F6;
      --white: #FFFFFF;
      --green: #22C55E;
      --red: #EF4444;
      --radius-sm: 10px;
      --radius-md: 16px;
      --radius-lg: 24px;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.07);
      --shadow-md: 0 8px 32px rgba(0,0,0,0.11);
      --shadow-lg: 0 20px 60px rgba(0,0,0,0.15);
    }

    html, body { height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: var(--gray-light); color: var(--navy); }

    /* ‚îÄ‚îÄ SCREEN TRANSITIONS ‚îÄ‚îÄ */
    .screen { display: none; }
    .screen.active { display: flex; flex-direction: column; min-height: 100vh; }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .site-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 40px; background: var(--white); border-bottom: 1px solid #E5E7EB; position: sticky; top: 0; z-index: 100; }
    .logo { font-size: 22px; font-weight: 800; color: var(--orange); letter-spacing: -0.5px; }
    .logo span { color: var(--navy); }
    .nav-links { display: flex; gap: 28px; }
    .nav-links a { text-decoration: none; color: var(--gray); font-size: 14px; font-weight: 500; transition: color .2s; }
    .nav-links a:hover { color: var(--navy); }
    .nav-cta { background: var(--orange); color: white; padding: 9px 20px; border-radius: 50px; font-size: 14px; font-weight: 600; text-decoration: none; transition: transform .2s, box-shadow .2s; }
    .nav-cta:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(255,98,0,0.3); }

    /* ‚îÄ‚îÄ LANDING HERO ‚îÄ‚îÄ */
    .hero { flex: 1; display: grid; grid-template-columns: 1fr 1fr; align-items: center; gap: 60px; padding: 80px 40px 60px; max-width: 1200px; margin: 0 auto; width: 100%; }
    .hero-badge { display: inline-flex; align-items: center; gap: 8px; background: var(--orange-light); color: var(--orange); font-size: 12px; font-weight: 700; padding: 6px 14px; border-radius: 50px; margin-bottom: 20px; border: 1px solid var(--orange-mid); letter-spacing: .4px; text-transform: uppercase; }
    .hero-title { font-size: 54px; font-weight: 800; line-height: 1.1; color: var(--navy); margin-bottom: 22px; letter-spacing: -1.5px; }
    .hero-title .hl { color: var(--orange); position: relative; }
    .hero-title .hl::after { content: ''; position: absolute; bottom: 4px; left: 0; right: 0; height: 3px; background: var(--orange); border-radius: 2px; opacity: .3; }
    .hero-sub { font-size: 17px; color: var(--gray); line-height: 1.65; margin-bottom: 36px; max-width: 440px; }
    .hero-cta { display: inline-flex; align-items: center; gap: 10px; background: var(--orange); color: white; font-size: 17px; font-weight: 700; padding: 16px 32px; border-radius: 50px; border: none; cursor: pointer; transition: all .25s; box-shadow: 0 4px 20px rgba(255,98,0,0.35); }
    .hero-cta:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(255,98,0,0.45); }
    .hero-cta svg { transition: transform .2s; }
    .hero-cta:hover svg { transform: translateX(3px); }
    .hero-meta { display: flex; align-items: center; gap: 20px; margin-top: 20px; font-size: 13px; color: var(--gray); }
    .hero-meta span { display: flex; align-items: center; gap: 6px; }
    .hero-old-link { color: var(--gray); text-decoration: underline; cursor: pointer; background: none; border: none; font-size: 13px; margin-top: 12px; display: inline-block; }
    .hero-old-link:hover { color: var(--navy); }

    /* ‚îÄ‚îÄ CHAT PREVIEW (landing) ‚îÄ‚îÄ */
    .hero-right { display: flex; flex-direction: column; align-items: center; gap: 20px; }
    .preview-window { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); padding: 24px; width: 340px; overflow: hidden; }
    .preview-header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--gray-light); }
    .nova-dot { width: 36px; height: 36px; background: linear-gradient(135deg, var(--orange), #FF8C42); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 14px; flex-shrink: 0; }
    .preview-name { font-weight: 700; font-size: 14px; }
    .preview-status { font-size: 12px; color: var(--green); display: flex; align-items: center; gap: 4px; }
    .status-dot { width: 7px; height: 7px; background: var(--green); border-radius: 50%; }
    .preview-bubbles { display: flex; flex-direction: column; gap: 10px; }
    .pb { font-size: 13px; line-height: 1.45; padding: 10px 14px; border-radius: 14px; max-width: 85%; animation: fadeSlideUp .5s ease forwards; opacity: 0; }
    .pb.nova { background: var(--orange-light); border-bottom-left-radius: 4px; color: var(--navy); align-self: flex-start; }
    .pb.user { background: var(--navy); color: white; border-bottom-right-radius: 4px; align-self: flex-end; }
    .pb:nth-child(1) { animation-delay: .2s; }
    .pb:nth-child(2) { animation-delay: .7s; }
    .pb:nth-child(3) { animation-delay: 1.3s; }
    .pb:nth-child(4) { animation-delay: 2.0s; }

    /* ‚îÄ‚îÄ CARD MOCKUP ‚îÄ‚îÄ */
    .card-mockup { width: 280px; height: 168px; background: linear-gradient(135deg, #1A1A2E 0%, #2D2D44 50%, #FF6200 100%); border-radius: 16px; padding: 22px; box-shadow: var(--shadow-lg); color: white; position: relative; overflow: hidden; }
    .card-mockup::before { content: ''; position: absolute; top: -30px; right: -30px; width: 120px; height: 120px; border-radius: 50%; background: rgba(255,255,255,0.07); }
    .card-mockup::after { content: ''; position: absolute; bottom: -20px; left: 20px; width: 80px; height: 80px; border-radius: 50%; background: rgba(255,98,0,0.3); }
    .card-brand { font-size: 18px; font-weight: 800; letter-spacing: 1px; opacity: .95; }
    .card-num { font-size: 13px; letter-spacing: 2px; margin: 18px 0 12px; opacity: .7; }
    .card-bottom { display: flex; justify-content: space-between; align-items: flex-end; }
    .card-name { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; opacity: .7; }
    .card-exp { font-size: 11px; opacity: .6; }
    .card-cashback { position: absolute; top: 22px; right: 22px; font-size: 9px; font-weight: 700; opacity: .8; text-align: right; line-height: 1.3; }
    .cashback-pct { font-size: 18px; font-weight: 800; color: var(--orange); display: block; }

    /* ‚îÄ‚îÄ BENEFITS ROW ‚îÄ‚îÄ */
    .benefits { background: var(--white); border-top: 1px solid #E5E7EB; padding: 28px 40px; }
    .benefits-inner { display: flex; justify-content: center; gap: 60px; max-width: 1200px; margin: 0 auto; }
    .benefit-item { display: flex; align-items: center; gap: 12px; font-size: 14px; font-weight: 500; color: var(--gray); }
    .benefit-icon { font-size: 22px; }

    /* ‚îÄ‚îÄ OLD FORM OVERLAY ‚îÄ‚îÄ */
    .old-form-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
    .old-form-overlay.visible { display: flex; }
    .old-form-box { background: white; border-radius: 16px; padding: 32px; max-width: 460px; width: 90%; max-height: 70vh; overflow-y: auto; position: relative; }
    .old-form-box h3 { font-size: 16px; font-weight: 700; margin-bottom: 4px; color: #EF4444; }
    .old-form-box p { font-size: 13px; color: var(--gray); margin-bottom: 20px; }
    .old-form-fields { display: flex; flex-direction: column; gap: 8px; }
    .old-field { background: var(--gray-light); border-radius: 8px; padding: 10px 14px; font-size: 12px; color: var(--gray); border-left: 3px solid #E5E7EB; }
    .old-field.sensitive { border-left-color: var(--red); }
    .old-form-close { position: absolute; top: 16px; right: 16px; background: none; border: none; cursor: pointer; font-size: 20px; color: var(--gray); }
    .pain-tag { display: inline-flex; gap: 4px; align-items: center; font-size: 11px; font-weight: 600; background: #FEF2F2; color: var(--red); padding: 3px 8px; border-radius: 50px; margin-left: 6px; }

    /* ‚îÄ‚îÄ CHAT EXPERIENCE ‚îÄ‚îÄ */
    #chat-experience { background: var(--gray-light); }
    .chat-layout { display: grid; grid-template-columns: 300px 1fr; flex: 1; max-width: 1100px; margin: 32px auto; width: 100%; gap: 20px; padding: 0 20px; }

    /* ‚îÄ‚îÄ PROFILE PANEL ‚îÄ‚îÄ */
    .profile-panel { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); padding: 24px; display: flex; flex-direction: column; gap: 16px; height: fit-content; position: sticky; top: 90px; }
    .panel-head { display: flex; justify-content: space-between; align-items: center; }
    .panel-head h3 { font-size: 14px; font-weight: 700; color: var(--navy); }
    .progress-pct { font-size: 13px; font-weight: 700; color: var(--orange); }
    .progress-track { height: 5px; background: #E5E7EB; border-radius: 10px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--orange), #FF8C42); border-radius: 10px; transition: width .6s cubic-bezier(.4,0,.2,1); width: 0%; }
    .profile-fields { display: flex; flex-direction: column; gap: 2px; }
    .pf-row { display: flex; align-items: center; gap: 10px; padding: 10px 8px; border-radius: var(--radius-sm); transition: background .3s; }
    .pf-row.filled { background: var(--orange-light); }
    .pf-icon { font-size: 16px; width: 24px; text-align: center; flex-shrink: 0; }
    .pf-info { flex: 1; min-width: 0; }
    .pf-label { font-size: 11px; font-weight: 600; color: var(--gray); text-transform: uppercase; letter-spacing: .4px; }
    .pf-value { font-size: 13px; font-weight: 500; color: var(--navy); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; transition: all .3s; }
    .pf-value.empty { color: #D1D5DB; }
    .pf-check { font-size: 14px; opacity: 0; transition: opacity .3s; color: var(--green); font-weight: 700; }
    .pf-row.filled .pf-check { opacity: 1; }
    .security-badge { background: var(--gray-light); border-radius: var(--radius-sm); padding: 10px 14px; display: flex; align-items: flex-start; gap: 8px; font-size: 11px; color: var(--gray); line-height: 1.5; }
    .demo-panel { border: 1px dashed #D1D5DB; border-radius: var(--radius-sm); padding: 12px; }
    .demo-panel p { font-size: 11px; font-weight: 700; color: var(--gray); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 8px; }
    .demo-btn { width: 100%; background: none; border: 1px solid #E5E7EB; border-radius: 8px; padding: 7px 10px; font-size: 12px; color: var(--gray); cursor: pointer; transition: all .2s; text-align: left; display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
    .demo-btn:hover { border-color: var(--orange); color: var(--orange); background: var(--orange-light); }

    /* ‚îÄ‚îÄ CHAT PANEL ‚îÄ‚îÄ */
    .chat-panel { background: var(--white); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; max-height: calc(100vh - 130px); }
    .chat-header { display: flex; align-items: center; gap: 12px; padding: 20px 24px; border-bottom: 1px solid #F3F4F6; flex-shrink: 0; }
    .nova-avatar { width: 42px; height: 42px; background: linear-gradient(135deg, var(--orange), #FF8C42); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 16px; flex-shrink: 0; box-shadow: 0 4px 12px rgba(255,98,0,0.3); }
    .nova-avatar.sm { width: 30px; height: 30px; font-size: 12px; }
    .chat-header-info { flex: 1; }
    .chat-header-name { font-weight: 700; font-size: 15px; }
    .chat-header-sub { font-size: 12px; color: var(--gray); display: flex; align-items: center; gap: 5px; }
    .online-dot { width: 7px; height: 7px; background: var(--green); border-radius: 50%; animation: pulse-green 2s infinite; }
    .chat-progress { display: flex; align-items: center; gap: 8px; }
    .chat-step { font-size: 12px; color: var(--gray); font-weight: 500; }
    .messages { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 14px; scroll-behavior: smooth; }
    .messages::-webkit-scrollbar { width: 4px; }
    .messages::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 4px; }
    .msg-row { display: flex; gap: 10px; animation: fadeSlideUp .35s ease; }
    .msg-row.user { flex-direction: row-reverse; }
    .msg-bubble { max-width: 70%; padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.55; }
    .msg-bubble.nova-bubble { background: var(--orange-light); color: var(--navy); border-bottom-left-radius: 4px; }
    .msg-bubble.user-bubble { background: var(--navy); color: white; border-bottom-right-radius: 4px; }
    .msg-time { font-size: 11px; color: #D1D5DB; align-self: flex-end; flex-shrink: 0; }
    .typing-row { display: flex; gap: 10px; align-items: center; }
    .typing-dots { display: flex; gap: 5px; background: var(--orange-light); padding: 12px 16px; border-radius: 18px; border-bottom-left-radius: 4px; }
    .typing-dots span { width: 7px; height: 7px; background: var(--orange); border-radius: 50%; animation: typing-bounce .8s ease infinite; opacity: .5; }
    .typing-dots span:nth-child(2) { animation-delay: .15s; }
    .typing-dots span:nth-child(3) { animation-delay: .3s; }
    .error-row { background: #FEF2F2; border: 1px solid #FECACA; border-radius: var(--radius-sm); padding: 12px 16px; font-size: 13px; color: #B91C1C; display: flex; align-items: center; justify-content: space-between; }
    .retry-btn { background: var(--red); color: white; border: none; border-radius: 8px; padding: 6px 14px; font-size: 12px; font-weight: 600; cursor: pointer; transition: opacity .2s; }
    .retry-btn:hover { opacity: .85; }
    .chat-input-area { padding: 16px 20px; border-top: 1px solid #F3F4F6; flex-shrink: 0; }
    .input-row { display: flex; align-items: flex-end; gap: 10px; }
    #user-input { flex: 1; border: 2px solid #E5E7EB; border-radius: var(--radius-sm); padding: 12px 16px; font-size: 14px; font-family: inherit; resize: none; outline: none; transition: border-color .2s; max-height: 120px; min-height: 46px; line-height: 1.5; }
    #user-input:focus { border-color: var(--orange); }
    #user-input:disabled { opacity: .5; cursor: not-allowed; }
    #send-btn { width: 46px; height: 46px; background: var(--orange); border: none; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all .2s; color: white; }
    #send-btn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 4px 12px rgba(255,98,0,0.3); }
    #send-btn:disabled { opacity: .4; cursor: not-allowed; }
    .input-footer { display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: #9CA3AF; }

    /* ‚îÄ‚îÄ RESULT SCREEN ‚îÄ‚îÄ */
    #result-screen { background: linear-gradient(135deg, #FFF4EE 0%, var(--gray-light) 100%); }
    .result-wrap { flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px 20px; }
    .result-card { background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); padding: 48px 40px; max-width: 520px; width: 100%; text-align: center; position: relative; overflow: hidden; }
    .confetti-line { position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--orange), #FF8C42, #FFD700, var(--green), #3B82F6, #8B5CF6); }
    .result-emoji { font-size: 56px; margin-bottom: 8px; }
    .result-badge { display: inline-block; background: var(--orange-light); color: var(--orange); font-size: 12px; font-weight: 700; padding: 5px 14px; border-radius: 50px; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 16px; border: 1px solid var(--orange-mid); }
    .result-title { font-size: 32px; font-weight: 800; color: var(--navy); line-height: 1.2; margin-bottom: 10px; }
    .result-subtitle { font-size: 16px; color: var(--gray); margin-bottom: 28px; }
    .result-card-visual { width: 320px; height: 190px; background: linear-gradient(135deg, var(--navy) 0%, var(--navy-soft) 60%, var(--orange) 140%); border-radius: 18px; margin: 0 auto 28px; padding: 26px; color: white; position: relative; overflow: hidden; box-shadow: 0 12px 40px rgba(0,0,0,0.2); }
    .result-card-visual::before { content: ''; position: absolute; top: -40px; right: -40px; width: 160px; height: 160px; border-radius: 50%; background: rgba(255,255,255,0.06); }
    .rcv-brand { font-size: 20px; font-weight: 800; letter-spacing: 1px; }
    .rcv-num { font-size: 14px; letter-spacing: 3px; margin: 20px 0 14px; opacity: .7; }
    .rcv-bottom { display: flex; justify-content: space-between; align-items: flex-end; }
    .rcv-holder { text-align: left; }
    .rcv-holder-label { font-size: 8px; opacity: .5; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 2px; }
    .rcv-holder-name { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; }
    .rcv-exp { font-size: 11px; opacity: .6; text-align: right; }
    .rcv-cashback { position: absolute; top: 24px; right: 24px; text-align: right; }
    .rcv-cb-pct { font-size: 22px; font-weight: 800; color: var(--orange); display: block; line-height: 1; }
    .rcv-cb-label { font-size: 9px; opacity: .7; }
    .offer-details { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 28px; }
    .offer-item { background: var(--gray-light); border-radius: var(--radius-sm); padding: 14px 12px; }
    .offer-label { font-size: 11px; color: var(--gray); font-weight: 600; text-transform: uppercase; letter-spacing: .4px; margin-bottom: 4px; }
    .offer-val { font-size: 14px; font-weight: 700; color: var(--navy); }
    .result-cta { display: block; width: 100%; background: var(--orange); color: white; font-size: 16px; font-weight: 700; padding: 16px; border-radius: 50px; border: none; cursor: pointer; margin-bottom: 12px; transition: all .25s; }
    .result-cta:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(255,98,0,0.35); }
    .result-restart { background: none; border: none; color: var(--gray); font-size: 13px; cursor: pointer; text-decoration: underline; }
    .result-disclaimer { font-size: 11px; color: #9CA3AF; margin-top: 16px; line-height: 1.5; }

    /* ‚îÄ‚îÄ KEYFRAMES ‚îÄ‚îÄ */
    @keyframes fadeSlideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse-green { 0%,100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); } 50% { box-shadow: 0 0 0 6px rgba(34,197,94,0); } }
    @keyframes typing-bounce { 0%,80%,100% { transform: translateY(0); opacity: .5; } 40% { transform: translateY(-5px); opacity: 1; } }
    @keyframes confetti-fall { 0% { transform: translateY(-10px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
    @keyframes spin-in { from { transform: scale(.8) rotate(-5deg); opacity: 0; } to { transform: scale(1) rotate(0deg); opacity: 1; } }

    .result-card { animation: spin-in .5s cubic-bezier(.34,1.56,.64,1); }

    .confetti-piece { position: fixed; width: 10px; height: 10px; border-radius: 2px; animation: confetti-fall linear forwards; pointer-events: none; z-index: 9999; }

    /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
    @media (max-width: 800px) {
      .hero { grid-template-columns: 1fr; padding: 40px 20px; gap: 40px; }
      .hero-title { font-size: 38px; }
      .hero-right { display: none; }
      .chat-layout { grid-template-columns: 1fr; }
      .profile-panel { display: none; }
      .benefits-inner { gap: 28px; flex-wrap: wrap; }
      .site-header { padding: 14px 20px; }
      .nav-links { display: none; }
    }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LANDING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="landing" class="screen active">
  <header class="site-header">
    <div class="logo">discover<span>.</span></div>
    <nav class="nav-links">
      <a href="#">Cards</a>
      <a href="#">Cash Back</a>
      <a href="#">Students</a>
      <a href="#">Help</a>
    </nav>
    <a class="nav-cta" href="#" onclick="startChat(); return false;">Get Pre-Approved</a>
  </header>

  <main class="hero">
    <div class="hero-left">
      <div class="hero-badge">‚ú® AI-Powered ¬∑ No Credit Impact</div>
      <h1 class="hero-title">Pre-approval<br>shouldn't feel like<br><span class="hl">a form.</span></h1>
      <p class="hero-sub">Meet Nova ‚Äî your personal Discover card guide. Skip the 15-field form and the walls of fine print. Just a quick, human conversation to see if you're pre-approved.</p>
      <button class="hero-cta" onclick="startChat()">
        Chat with Nova
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </button>
      <div class="hero-meta">
        <span>‚ö° Under 2 minutes</span>
        <span>üõ°Ô∏è Soft inquiry only</span>
        <span>üéØ Personalized offers</span>
      </div>
      <button class="hero-old-link" onclick="document.getElementById('old-form-overlay').classList.add('visible')">See what we replaced ‚Üí</button>
    </div>

    <div class="hero-right">
      <div class="preview-window">
        <div class="preview-header">
          <div class="nova-dot">N</div>
          <div>
            <div class="preview-name">Nova</div>
            <div class="preview-status"><span class="status-dot"></span> Online</div>
          </div>
        </div>
        <div class="preview-bubbles">
          <div class="pb nova">Hi! I'm Nova üëã I'll help you see if you're pre-approved ‚Äî no credit score impact.</div>
          <div class="pb user">Sounds good, let's do it!</div>
          <div class="pb nova">Great! What's your first and last name?</div>
          <div class="pb user">Alex Johnson</div>
        </div>
      </div>

      <div class="card-mockup">
        <div class="card-brand">DISCOVER IT¬Æ</div>
        <div class="card-num">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ &nbsp;‚Ä¢‚Ä¢‚Ä¢‚Ä¢ &nbsp;‚Ä¢‚Ä¢‚Ä¢‚Ä¢ &nbsp;1234</div>
        <div class="card-bottom">
          <div>
            <div class="card-name">YOUR NAME HERE</div>
            <div class="card-exp">12/29</div>
          </div>
        </div>
        <div class="card-cashback">
          <span class="cashback-pct">5%</span>
          cash back
        </div>
      </div>
    </div>
  </main>

  <div class="benefits">
    <div class="benefits-inner">
      <div class="benefit-item"><span class="benefit-icon">üí¨</span> Guided conversation, not a form</div>
      <div class="benefit-item"><span class="benefit-icon">üîí</span> Bank-level security</div>
      <div class="benefit-item"><span class="benefit-icon">‚ö°</span> See your offer in 2 minutes</div>
      <div class="benefit-item"><span class="benefit-icon">üéØ</span> 5% cash back on rotating categories</div>
    </div>
  </div>
</div>

<!-- OLD FORM OVERLAY (edge case demo) -->
<div id="old-form-overlay" class="old-form-overlay" onclick="if(event.target===this)this.classList.remove('visible')">
  <div class="old-form-box">
    <button class="old-form-close" onclick="document.getElementById('old-form-overlay').classList.remove('visible')">‚úï</button>
    <h3>üò∞ The old experience</h3>
    <p>This is what users faced before Nova. 15 fields. 2 consent checkboxes. A wall of legal text. No guidance.</p>
    <div class="old-form-fields">
      <div class="old-field">üë§ First Name</div>
      <div class="old-field">üë§ Middle Name (optional)</div>
      <div class="old-field">üë§ Last Name</div>
      <div class="old-field">üè† Street Address</div>
      <div class="old-field">üè† Apartment / Suite</div>
      <div class="old-field">üè† City, State, ZIP</div>
      <div class="old-field">üéÇ Date of Birth <span class="pain-tag">‚ö†Ô∏è No context given</span></div>
      <div class="old-field sensitive">üîê Full Social Security Number <span class="pain-tag">‚ö†Ô∏è Anxiety spike</span></div>
      <div class="old-field">üéì Are you a student?</div>
      <div class="old-field">üèòÔ∏è Housing Status & Monthly Payment</div>
      <div class="old-field">üí∞ Total Annual Gross Income</div>
      <div class="old-field">üè¶ Bank Accounts Owned</div>
      <div class="old-field">üìß Email Address</div>
      <div class="old-field sensitive">üìú Legal consent block ‚Äî 800+ words <span class="pain-tag">‚ö†Ô∏è Nobody reads</span></div>
      <div class="old-field sensitive">‚òëÔ∏è 2x checkbox consents <span class="pain-tag">‚ö†Ô∏è Trust drop</span></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHAT EXPERIENCE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="chat-experience" class="screen">
  <header class="site-header">
    <div class="logo">discover<span>.</span></div>
    <nav class="nav-links">
      <a href="#">Cards</a>
      <a href="#">Cash Back</a>
      <a href="#">Help</a>
    </nav>
    <a class="nav-cta" style="background:#F3F4F6;color:var(--navy)" href="#" onclick="goToLanding(); return false;">‚Üê Back</a>
  </header>

  <div class="chat-layout">
    <!-- Profile Panel -->
    <div class="profile-panel">
      <div class="panel-head">
        <h3>Your Profile</h3>
        <span class="progress-pct" id="progress-pct">0%</span>
      </div>
      <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
      <div class="profile-fields">
        <div class="pf-row" id="pf-name">
          <span class="pf-icon">üë§</span>
          <div class="pf-info">
            <div class="pf-label">Name</div>
            <div class="pf-value empty" id="pv-name">‚Äî</div>
          </div>
          <span class="pf-check">‚úì</span>
        </div>
        <div class="pf-row" id="pf-address">
          <span class="pf-icon">üè†</span>
          <div class="pf-info">
            <div class="pf-label">Address</div>
            <div class="pf-value empty" id="pv-address">‚Äî</div>
          </div>
          <span class="pf-check">‚úì</span>
        </div>
        <div class="pf-row" id="pf-dob">
          <span class="pf-icon">üéÇ</span>
          <div class="pf-info">
            <div class="pf-label">Date of Birth</div>
            <div class="pf-value empty" id="pv-dob">‚Äî</div>
          </div>
          <span class="pf-check">‚úì</span>
        </div>
        <div class="pf-row" id="pf-income">
          <span class="pf-icon">üí∞</span>
          <div class="pf-info">
            <div class="pf-label">Annual Income</div>
            <div class="pf-value empty" id="pv-income">‚Äî</div>
          </div>
          <span class="pf-check">‚úì</span>
        </div>
        <div class="pf-row" id="pf-housing">
          <span class="pf-icon">üèòÔ∏è</span>
          <div class="pf-info">
            <div class="pf-label">Housing</div>
            <div class="pf-value empty" id="pv-housing">‚Äî</div>
          </div>
          <span class="pf-check">‚úì</span>
        </div>
        <div class="pf-row" id="pf-bank">
          <span class="pf-icon">üè¶</span>
          <div class="pf-info">
            <div class="pf-label">Bank Accounts</div>
            <div class="pf-value empty" id="pv-bank">‚Äî</div>
          </div>
          <span class="pf-check">‚úì</span>
        </div>
        <div class="pf-row" id="pf-email">
          <span class="pf-icon">‚úâÔ∏è</span>
          <div class="pf-info">
            <div class="pf-label">Email</div>
            <div class="pf-value empty" id="pv-email">‚Äî</div>
          </div>
          <span class="pf-check">‚úì</span>
        </div>
        <div class="pf-row" id="pf-id">
          <span class="pf-icon">üîê</span>
          <div class="pf-info">
            <div class="pf-label">Identity</div>
            <div class="pf-value empty" id="pv-id">‚Äî</div>
          </div>
          <span class="pf-check">‚úì</span>
        </div>
      </div>
      <div class="security-badge">
        üîí&nbsp; Bank-level encryption. Soft inquiry only ‚Äî no credit score impact.
      </div>
      <div class="demo-panel">
        <p>üß™ Demo controls</p>
        <button class="demo-btn" onclick="simulateError()">‚ö° Simulate connection error</button>
        <button class="demo-btn" onclick="resetChat()">‚Ü©Ô∏è Restart conversation</button>
      </div>
    </div>

    <!-- Chat Panel -->
    <div class="chat-panel">
      <div class="chat-header">
        <div class="nova-avatar">N</div>
        <div class="chat-header-info">
          <div class="chat-header-name">Nova</div>
          <div class="chat-header-sub"><span class="online-dot"></span> Discover AI ¬∑ Soft inquiry ¬∑ No credit impact</div>
        </div>
        <div class="chat-progress">
          <span class="chat-step" id="chat-step">Step 1 of 8</span>
        </div>
      </div>

      <div class="messages" id="messages"></div>

      <div class="chat-input-area">
        <div class="input-row">
          <textarea id="user-input" placeholder="Type your response..." rows="1" onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
          <button id="send-btn" onclick="sendUserMessage()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13M22 2L15 22l-4-9-9-4 20-7z"/></svg>
          </button>
        </div>
        <div class="input-footer">
          <span>üîí Secure ¬∑ Encrypted</span>
          <span>Enter to send &nbsp;¬∑&nbsp; Shift+Enter for new line</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESULT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="result-screen" class="screen">
  <header class="site-header">
    <div class="logo">discover<span>.</span></div>
  </header>
  <div class="result-wrap">
    <div class="result-card">
      <div class="confetti-line"></div>
      <div class="result-emoji">üéâ</div>
      <div class="result-badge">Pre-Approved!</div>
      <h2 class="result-title" id="result-title">Great news!</h2>
      <p class="result-subtitle">You may be pre-approved for the <strong>Discover it¬Æ Cash Back</strong> card.</p>

      <div class="result-card-visual">
        <div class="rcv-brand">DISCOVER IT¬Æ</div>
        <div class="rcv-num">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ &nbsp; ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ &nbsp; ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ &nbsp; 1234</div>
        <div class="rcv-bottom">
          <div class="rcv-holder">
            <div class="rcv-holder-label">Cardholder</div>
            <div class="rcv-holder-name" id="rcv-name">YOUR NAME</div>
          </div>
          <div class="rcv-exp">12/29</div>
        </div>
        <div class="rcv-cashback">
          <span class="rcv-cb-pct">5%</span>
          <span class="rcv-cb-label">CASH BACK</span>
        </div>
      </div>

      <div class="offer-details">
        <div class="offer-item">
          <div class="offer-label">APR Range</div>
          <div class="offer-val">18.24‚Äì27.24%</div>
        </div>
        <div class="offer-item">
          <div class="offer-label">Cash Back</div>
          <div class="offer-val">5% rotating</div>
        </div>
        <div class="offer-item">
          <div class="offer-label">Intro Bonus</div>
          <div class="offer-val">Cashback Match‚Ñ¢</div>
        </div>
      </div>

      <button class="result-cta">Complete My Application ‚Üí</button>
      <button class="result-restart" onclick="resetToLanding()">Start over</button>
      <p class="result-disclaimer">Pre-approval is not a guarantee of final approval. A hard inquiry will be performed upon full application. Your offer terms may vary based on creditworthiness.</p>
    </div>
  </div>
</div>

<script>
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  NOVA ‚Äî SELF-CONTAINED SCRIPTED ENGINE
  //  Works 100% offline. No API required.
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  let profile = {};
  let step = 0;       // which question we're waiting on
  let isWaiting = false;
  let clarifyCount = 0; // retries on current step

  // ‚îÄ‚îÄ FIELD GROUPS for profile panel ‚îÄ‚îÄ
  const FIELD_GROUPS = [
    { id: 'pf-name',    keys: ['firstName','lastName'],  pvId: 'pv-name',    fmt: p => `${p.firstName||''} ${p.lastName||''}`.trim() },
    { id: 'pf-address', keys: ['city','state'],           pvId: 'pv-address', fmt: p => p.city ? `${p.city}, ${p.state}` : '' },
    { id: 'pf-dob',     keys: ['dateOfBirth'],            pvId: 'pv-dob',     fmt: p => p.dateOfBirth },
    { id: 'pf-income',  keys: ['annualIncome'],           pvId: 'pv-income',  fmt: p => p.annualIncome ? `$${Number(p.annualIncome).toLocaleString()}/yr` : '' },
    { id: 'pf-housing', keys: ['housingStatus'],          pvId: 'pv-housing', fmt: p => p.housingStatus ? `${p.housingStatus} ¬∑ $${p.monthlyHousingPayment||0}/mo` : '' },
    { id: 'pf-bank',    keys: ['bankAccounts'],           pvId: 'pv-bank',    fmt: p => p.bankAccounts },
    { id: 'pf-email',   keys: ['email'],                  pvId: 'pv-email',   fmt: p => p.email },
    { id: 'pf-id',      keys: ['last4SSN'],               pvId: 'pv-id',      fmt: p => p.last4SSN ? `‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢${p.last4SSN}` : '' },
  ];

  // ‚îÄ‚îÄ STEP DEFINITIONS ‚îÄ‚îÄ
  // Each step: ask() ‚Üí what Nova says, parse(input) ‚Üí extracted data or null
  const STEPS = [

    // STEP 0 ‚Äî opening (no user input yet)
    {
      ask: () => `Hi there! üëã I'm Nova, your Discover card guide. I'll help you check if you're pre-approved in just a couple of minutes ‚Äî and it won't affect your credit score at all.\n\nLet's start simple: what's your first and last name?`,
      parse: (input) => {
        const parts = input.trim().split(/\s+/);
        if (parts.length >= 2) {
          return { firstName: cap(parts[0]), lastName: cap(parts.slice(1).join(' ')) };
        }
        return null;
      },
      clarify: () => `No worries ‚Äî could you give me your full name, first and last? For example: "Jane Smith".`,
      field: 'name'
    },

    // STEP 1 ‚Äî address
    {
      ask: (p) => `Nice to meet you, ${p.firstName}! üòä Next up ‚Äî what's your current home address? I'll need your street address, city, state, and ZIP code.`,
      parse: (input) => {
        // Try to extract city, state, zip from free text
        const zipMatch = input.match(/\b(\d{5})\b/);
        const stateMatch = input.match(/\b([A-Z]{2})\b/) || input.match(/,\s*([A-Za-z]{2,20})\s*\d{5}/);
        // Split on commas for city detection
        const parts = input.split(',').map(s => s.trim());
        const city = parts.length >= 2 ? cap(parts[parts.length - 2].replace(/^\d+\s+\w+\s+\w+\s*/,'')) || cap(parts[0]) : cap(parts[0]);
        const stateRaw = stateMatch ? stateMatch[1].toUpperCase().slice(0,2) : 'NY';
        const zip = zipMatch ? zipMatch[1] : '10001';
        const street = parts[0].trim();
        if (input.length > 5) {
          return { streetAddress: cap(street), city: city||'Your City', state: stateRaw, zip };
        }
        return null;
      },
      clarify: () => `Got it ‚Äî could you share that in a bit more detail? Something like "123 Main St, Austin, TX 78701" works perfectly.`,
      field: 'address'
    },

    // STEP 2 ‚Äî date of birth
    {
      ask: (p) => `Got it, thanks! And what's your date of birth? (You'll need to be 18 or older to apply.)`,
      parse: (input) => {
        // Accept MM/DD/YYYY, MM-DD-YYYY, written dates, etc.
        const clean = input.replace(/[^\d\/\-\s]/g,'').trim();
        const match = input.match(/(\d{1,2})[\/\-\s](\d{1,2})[\/\-\s](\d{2,4})/);
        if (match) {
          const y = match[3].length === 2 ? '19' + match[3] : match[3];
          const age = new Date().getFullYear() - parseInt(y);
          if (age < 18) return { __under18: true };
          return { dateOfBirth: `${match[1].padStart(2,'0')}/${match[2].padStart(2,'0')}/${y}` };
        }
        return null;
      },
      clarify: () => `Could you share your date of birth in MM/DD/YYYY format? For example, 04/15/1990.`,
      field: 'dob'
    },

    // STEP 3 ‚Äî income
    {
      ask: (p) => `Perfect. Now let's talk about your financial picture ‚Äî this helps me match you to the right card.\n\nWhat's your approximate total annual income? Even a rough estimate is fine.`,
      parse: (input) => {
        const lower = input.toLowerCase();
        let amount = null;
        const kMatch = lower.match(/([\d,\.]+)\s*k/);
        const mMatch = lower.match(/([\d,\.]+)\s*m/);
        const rawMatch = input.match(/([\d,]+)/);
        if (kMatch) amount = Math.round(parseFloat(kMatch[1]) * 1000);
        else if (mMatch) amount = Math.round(parseFloat(mMatch[1]) * 1000000);
        else if (rawMatch) amount = parseInt(rawMatch[1].replace(/,/g,''));
        if (amount !== null && amount >= 0) return { annualIncome: String(amount) };
        return null;
      },
      clarify: () => `Just a ballpark works fine! Something like "$45,000" or "about 60k" is perfect.`,
      field: 'income'
    },

    // STEP 4 ‚Äî housing
    {
      ask: (p) => `Got it. Do you own your home, rent, or something else? And roughly what's your monthly housing payment? (Enter 0 if you have none.)`,
      parse: (input) => {
        const lower = input.toLowerCase();
        let status = null;
        if (/own|mortgage|bought|purchase/.test(lower)) status = 'Own';
        else if (/rent|tenant|lease/.test(lower)) status = 'Rent';
        else if (/live with|parents|family|free|none|no payment/.test(lower)) status = 'Other';
        const numMatch = input.match(/([\d,]+)/);
        const payment = numMatch ? parseInt(numMatch[1].replace(/,/g,'')) : 0;
        if (status) return { housingStatus: status, monthlyHousingPayment: String(payment) };
        return null;
      },
      clarify: () => `No problem ‚Äî just let me know if you own your home, rent, or have another arrangement, and roughly what your monthly payment is (or 0 if none).`,
      field: 'housing'
    },

    // STEP 5 ‚Äî bank accounts
    {
      ask: (p) => `Thanks! Do you have a checking account, savings account, both, or neither?`,
      parse: (input) => {
        const lower = input.toLowerCase();
        if (/both|checking.*saving|saving.*checking/.test(lower)) return { bankAccounts: 'Both' };
        if (/checking|debit/.test(lower)) return { bankAccounts: 'Checking' };
        if (/saving|ira|money market/.test(lower)) return { bankAccounts: 'Savings' };
        if (/neither|none|no account|don.t have/.test(lower)) return { bankAccounts: 'None' };
        return null;
      },
      clarify: () => `Just checking ‚Äî do you have a checking account, savings account, both, or neither? Any of those works!`,
      field: 'bank'
    },

    // STEP 6 ‚Äî email
    {
      ask: (p) => `Almost there, ${p.firstName}! What's the best email address to send your pre-approval result to?`,
      parse: (input) => {
        const emailMatch = input.match(/[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}/);
        if (emailMatch) return { email: emailMatch[0].toLowerCase() };
        return null;
      },
      clarify: () => `I just need a valid email address ‚Äî something like yourname@example.com.`,
      field: 'email'
    },

    // STEP 7 ‚Äî SSN last 4
    {
      ask: (p) => `One last thing! To verify your identity and run a soft check (which has absolutely no impact on your credit score), could you share the last 4 digits of your Social Security Number?\n\nüîí This is encrypted and used only for this check.`,
      parse: (input) => {
        const lower = input.toLowerCase();
        // Handle refusal
        if (/no|won.t|refuse|not comfortable|don.t want|skip|privacy/.test(lower)) {
          return { __ssnRefused: true };
        }
        const digits = input.replace(/\D/g,'');
        if (digits.length === 4) return { last4SSN: digits };
        if (digits.length > 4) return { last4SSN: digits.slice(-4) }; // take last 4 if they gave more
        return null;
      },
      clarify: (p) => `Totally understandable if you're hesitant ‚Äî this is just the last 4 digits (not your full SSN), and it's a soft pull so it won't touch your credit score at all. Ready to share them, ${p.firstName}?`,
      field: 'id'
    },
  ];

  // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
  function cap(s) {
    if (!s) return s;
    return s.replace(/\b\w/g, c => c.toUpperCase());
  }

  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0,0);
  }

  function getTime() {
    return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  }

  function addMessage(role, text) {
    const msgs = document.getElementById('messages');
    const row = document.createElement('div');
    row.className = `msg-row ${role === 'user' ? 'user' : ''}`;
    const avatarHtml = role === 'nova' ? `<div class="nova-avatar sm">N</div>` : '';
    if (!text.trim()) return;
    row.innerHTML = `
      ${avatarHtml}
      <div class="msg-bubble ${role === 'user' ? 'user-bubble' : 'nova-bubble'}">${text.replace(/\n/g,'<br>')}</div>
      <span class="msg-time">${getTime()}</span>`;
    msgs.appendChild(row);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function showTyping() {
    hideTyping();
    const msgs = document.getElementById('messages');
    const row = document.createElement('div');
    row.id = 'typing-indicator';
    row.className = 'typing-row';
    row.innerHTML = `<div class="nova-avatar sm">N</div><div class="typing-dots"><span></span><span></span><span></span></div>`;
    msgs.appendChild(row);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function hideTyping() {
    const t = document.getElementById('typing-indicator');
    if (t) t.remove();
  }

  function showError() {
    const msgs = document.getElementById('messages');
    const row = document.createElement('div');
    row.id = 'error-row';
    row.className = 'error-row';
    row.innerHTML = `‚ö†Ô∏è Connection issue ‚Äî couldn't reach Nova. <button class="retry-btn" onclick="dismissError()">Dismiss</button>`;
    msgs.appendChild(row);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function clearError() {
    const e = document.getElementById('error-row');
    if (e) e.remove();
  }

  function setInputEnabled(enabled) {
    document.getElementById('user-input').disabled = !enabled;
    document.getElementById('send-btn').disabled = !enabled;
    if (enabled) setTimeout(() => document.getElementById('user-input').focus(), 50);
  }

  function autoResize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  }

  function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendUserMessage(); }
  }

  function updateProfilePanel(data) {
    Object.assign(profile, data);
    let filled = 0;
    FIELD_GROUPS.forEach(group => {
      const isDone = group.keys.every(k => profile[k]);
      const row = document.getElementById(group.id);
      const pv = document.getElementById(group.pvId);
      if (isDone) {
        row.classList.add('filled');
        pv.classList.remove('empty');
        pv.textContent = group.fmt(profile) || '‚úì';
        filled++;
      }
    });
    const pct = Math.round((filled / FIELD_GROUPS.length) * 100);
    document.getElementById('progress-fill').style.width = pct + '%';
    document.getElementById('progress-pct').textContent = pct + '%';
    document.getElementById('chat-step').textContent = `Step ${Math.min(filled+1, 8)} of 8`;
  }

  // ‚îÄ‚îÄ NOVA SPEAKS (with simulated typing delay) ‚îÄ‚îÄ
  function novaRespond(text, delay = 900) {
    setInputEnabled(false);
    showTyping();
    setTimeout(() => {
      hideTyping();
      addMessage('nova', text);
      setInputEnabled(true);
    }, delay);
  }

  // ‚îÄ‚îÄ MAIN CONVERSATION ENGINE ‚îÄ‚îÄ
  function processUserInput(input) {
    if (isWaiting || step >= STEPS.length) return;
    isWaiting = true;
    setInputEnabled(false);

    const currentStep = STEPS[step];
    const parsed = currentStep.parse(input);

    // ‚îÄ‚îÄ Edge: under 18 ‚îÄ‚îÄ
    if (parsed && parsed.__under18) {
      isWaiting = false;
      novaRespond(`Thanks for sharing that! Unfortunately, you need to be 18 or older to apply for a Discover card. When the time comes, we'd love to help you find the right card ‚Äî we'll be here! üòä`, 900);
      return;
    }

    // ‚îÄ‚îÄ Edge: SSN refused ‚îÄ‚îÄ
    if (parsed && parsed.__ssnRefused) {
      if (clarifyCount === 0) {
        clarifyCount++;
        isWaiting = false;
        novaRespond(`Totally understandable ‚Äî your security matters! Just to clarify: this is only the last 4 digits of your SSN (not the full number), and it's a soft pull that won't affect your credit score at all. Your data is bank-level encrypted.\n\nReady to share those last 4 digits, ${profile.firstName}?`, 1000);
        return;
      } else {
        isWaiting = false;
        novaRespond(`No problem at all ‚Äî I completely understand. Those 4 digits are required to complete the pre-approval check. If you'd like to continue, feel free to come back anytime! üôÇ`, 900);
        return;
      }
    }

    // ‚îÄ‚îÄ Parsed successfully ‚îÄ‚îÄ
    if (parsed) {
      updateProfilePanel(parsed);
      clarifyCount = 0;
      step++;

      // All steps done?
      if (step >= STEPS.length) {
        isWaiting = false;
        setInputEnabled(false);
        showTyping();
        setTimeout(() => {
          hideTyping();
          addMessage('nova', `That's everything I need, ${profile.firstName}! Let me check your eligibility now... üîç`);
          showTyping();
          setTimeout(() => {
            hideTyping();
            addMessage('nova', `üéâ Great news ‚Äî you appear to be pre-approved! Taking you to your offer now...`);
            setTimeout(() => triggerResult(), 1400);
          }, 2200);
        }, 900);
        return;
      }

      // Ask next question
      isWaiting = false;
      const nextStep = STEPS[step];
      novaRespond(nextStep.ask(profile), 850);
      return;
    }

    // ‚îÄ‚îÄ Couldn't parse ‚Äî check for FAQ / off-topic ‚îÄ‚îÄ
    const lower = input.toLowerCase();
    const faqs = [
      { test: /apr|interest rate/, reply: `The Discover it¬Æ Cash Back currently offers a 0% intro APR for 15 months on purchases, then a variable APR. Let's find out the exact rate you qualify for ‚Äî ` },
      { test: /cash.?back|reward/, reply: `Discover it¬Æ Cash Back earns 5% cash back on rotating categories (like gas, groceries, restaurants) and 1% on everything else. Plus, Discover matches all your cash back in the first year! Now, ` },
      { test: /credit score|hard.?pull|soft.?pull/, reply: `Totally valid question! Checking for pre-approval is a soft inquiry ‚Äî it has zero impact on your credit score. Only a full application creates a hard inquiry. ` },
      { test: /how long|how much time/, reply: `This whole process takes about 2 minutes ‚Äî you're already making great progress! ` },
      { test: /safe|secure|privacy|data/, reply: `Your data is protected with bank-level 256-bit encryption. We only use it to check your pre-approval eligibility. ` },
    ];

    const matched = faqs.find(f => f.test.test(lower));
    if (matched) {
      const redirects = [
        `shall we continue?`,
        `ready to move on?`,
        `let's keep going!`,
      ];
      const redir = redirects[step % redirects.length];
      isWaiting = false;
      novaRespond(matched.reply + `${STEPS[step].ask(profile).split('\n')[0]} ‚Äî ${redir}`, 1000);
      return;
    }

    // ‚îÄ‚îÄ Couldn't parse + no FAQ match ‚Üí clarify ‚îÄ‚îÄ
    if (clarifyCount < 2) {
      clarifyCount++;
      isWaiting = false;
      const clarifyMsg = typeof currentStep.clarify === 'function'
        ? currentStep.clarify(profile)
        : currentStep.clarify;
      novaRespond(clarifyMsg, 800);
    } else {
      // Accept gracefully and move on with a default
      const defaults = {
        name: { firstName: 'Friend', lastName: '' },
        address: { streetAddress: '‚Äî', city: 'Your City', state: 'NY', zip: '10001' },
        dob: { dateOfBirth: '01/01/1990' },
        income: { annualIncome: '50000' },
        housing: { housingStatus: 'Other', monthlyHousingPayment: '0' },
        bank: { bankAccounts: 'Checking' },
        email: { email: 'user@example.com' },
        id: { last4SSN: '0000' },
      };
      const fallback = defaults[currentStep.field] || {};
      updateProfilePanel(fallback);
      clarifyCount = 0;
      step++;
      isWaiting = false;
      if (step < STEPS.length) novaRespond(STEPS[step].ask(profile), 800);
    }
  }

  // ‚îÄ‚îÄ PUBLIC FUNCTIONS ‚îÄ‚îÄ
  function sendUserMessage() {
    const input = document.getElementById('user-input');
    const text = input.value.trim();
    if (!text || isWaiting) return;
    input.value = '';
    input.style.height = 'auto';
    addMessage('user', text);
    setTimeout(() => processUserInput(text), 100);
  }

  function triggerResult() {
    const firstName = profile.firstName || '';
    const lastName = profile.lastName || '';
    const fullName = `${firstName} ${lastName}`.trim().toUpperCase() || 'YOUR NAME';
    document.getElementById('result-title').textContent = `Great news${firstName ? ', ' + firstName : ''}!`;
    document.getElementById('rcv-name').textContent = fullName;
    showScreen('result-screen');
    launchConfetti();
  }

  function launchConfetti() {
    const colors = ['#FF6200','#FFD700','#22C55E','#3B82F6','#8B5CF6','#EC4899'];
    for (let i = 0; i < 60; i++) {
      setTimeout(() => {
        const el = document.createElement('div');
        el.className = 'confetti-piece';
        el.style.cssText = `left:${Math.random()*100}vw;top:-20px;background:${colors[Math.floor(Math.random()*colors.length)]};width:${6+Math.random()*8}px;height:${6+Math.random()*8}px;border-radius:${Math.random()>.5?'50%':'2px'};animation-duration:${1.5+Math.random()*2}s;animation-delay:${Math.random()*.5}s;`;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 3000);
      }, i * 30);
    }
  }

  function simulateError() {
    clearError();
    showError();
  }

  function dismissError() { clearError(); }

  function startChat() {
    showScreen('chat-experience');
    profile = {};
    step = 0;
    clarifyCount = 0;
    isWaiting = false;
    document.getElementById('messages').innerHTML = '';
    FIELD_GROUPS.forEach(g => {
      document.getElementById(g.id).classList.remove('filled');
      const pv = document.getElementById(g.pvId);
      pv.classList.add('empty');
      pv.textContent = '‚Äî';
    });
    document.getElementById('progress-fill').style.width = '0%';
    document.getElementById('progress-pct').textContent = '0%';
    document.getElementById('chat-step').textContent = 'Step 1 of 8';
    // Nova opens
    novaRespond(STEPS[0].ask(), 700);
  }

  function resetChat() { startChat(); }
  function goToLanding() { showScreen('landing'); }
  function resetToLanding() { showScreen('landing'); }
</script>
</body>
</html>
